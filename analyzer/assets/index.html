<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analyzer</title>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --ok: #22c55e;
        --fail: #ef4444;
        --line: #1f2937;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Segoe UI", "Malgun Gothic", sans-serif;
      }
      .app { min-height: 100vh; display: grid; grid-template-rows: auto 1fr auto; }
      .top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--line);
        background: rgba(17,24,39,.9);
      }
      .left-actions { display: flex; gap: 8px; align-items: center; }
      .status {
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 13px;
        font-weight: 600;
      }
      .status.ok {
        background: rgba(34,197,94,.15);
        color: var(--ok);
        border: 1px solid rgba(34,197,94,.35);
      }
      .status.fail {
        background: rgba(239,68,68,.15);
        color: var(--fail);
        border: 1px solid rgba(239,68,68,.35);
      }
      .main {
        display: grid;
        grid-template-columns: 260px 1fr;
        min-height: 0;
      }
      .sessions {
        border-right: 1px solid var(--line);
        background: rgba(17,24,39,.7);
        padding: 10px;
        overflow-y: auto;
      }
      .sessions.hidden { display: none; }
      .session-item {
        width: 100%;
        text-align: left;
        border: 1px solid #263244;
        border-radius: 10px;
        background: #141d2b;
        color: var(--text);
        padding: 10px;
        margin-bottom: 8px;
        cursor: pointer;
      }
      .session-item.active { border-color: #3b82f6; }
      .session-meta { font-size: 12px; color: var(--muted); margin-top: 6px; }
      .chat { padding: 20px; overflow-y: auto; }
      .guide {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 14px;
        color: var(--muted);
      }
      .messages { display: flex; flex-direction: column; gap: 10px; }
      .bubble {
        max-width: min(760px, 88%);
        border-radius: 12px;
        padding: 10px 12px;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .bubble.user {
        margin-left: auto;
        background: #1d4ed8;
      }
      .bubble.assistant {
        margin-right: auto;
        background: #1f2937;
        border: 1px solid #374151;
      }
      .failure-actions { display: none; gap: 10px; margin-top: 10px; }
      .composer {
        border-top: 1px solid var(--line);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(17,24,39,.9);
      }
      button {
        border: 1px solid #334155;
        border-radius: 10px;
        background: #1e293b;
        color: var(--text);
        padding: 8px 12px;
        cursor: pointer;
      }
      button:hover { background: #273549; }
      textarea {
        flex: 1;
        resize: none;
        min-height: 42px;
        max-height: 140px;
        background: #0b1220;
        border: 1px solid #243041;
        border-radius: 10px;
        color: var(--text);
        padding: 10px 12px;
        font-family: inherit;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="top">
        <div class="left-actions">
          <button id="btn-new">ÏÉà Ï±ÑÌåÖ (+)</button>
          <button id="btn-toggle">ÏÑ∏ÏÖò Î™©Î°ù ÌÜ†Í∏Ä</button>
          <button id="btn-delete">ÏÑ∏ÏÖò ÏÇ≠Ï†ú</button>
        </div>
        <div id="status-badge" class="status fail">Ïó∞Í≤∞ Ïã§Ìå®</div>
      </header>

      <div class="main" id="main-layout">
        <aside class="sessions" id="sessions"></aside>
        <section class="chat" id="chat">
          <div class="guide">
            Analyzer Phase 3: ÏÑ∏ÏÖò/Î°úÍ∑∏(history.jsonl) Í∏∞Î∞ò UIÏûÖÎãàÎã§.
            <div class="failure-actions" id="failure-actions">
              <button id="btn-install">Install/Build Engine</button>
              <button id="btn-download">Download Model</button>
            </div>
          </div>
          <div class="messages" id="messages"></div>
        </section>
      </div>

      <footer class="composer">
        <button title="ÌååÏùº Ï≤®Î∂Ä">üìé</button>
        <textarea id="input" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî. Enter Ï†ÑÏÜ° / Shift+Enter Ï§ÑÎ∞îÍøà"></textarea>
      </footer>
    </div>

    <script>
      const state = {
        connectionOk: false,
        sessions: [],
        currentSessionId: null,
        messages: [],
        sessionsVisible: true,
      };

      function $(id) { return document.getElementById(id); }

      function toast(msg) { alert(msg || 'not implemented yet'); }

      function renderStatus() {
        const badge = $('status-badge');
        badge.textContent = state.connectionOk ? 'Ïó∞Í≤∞ ÏÑ±Í≥µ' : 'Ïó∞Í≤∞ Ïã§Ìå®';
        badge.className = `status ${state.connectionOk ? 'ok' : 'fail'}`;
        $('failure-actions').style.display = state.connectionOk ? 'none' : 'flex';
      }

      function renderSessions() {
        const root = $('sessions');
        root.innerHTML = '';

        if (state.sessions.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'session-meta';
          empty.textContent = 'ÏÑ∏ÏÖòÏù¥ ÏóÜÏäµÎãàÎã§. ÏÉà Ï±ÑÌåÖÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî.';
          root.appendChild(empty);
          return;
        }

        state.sessions.forEach((s) => {
          const btn = document.createElement('button');
          btn.className = `session-item ${s.session_id === state.currentSessionId ? 'active' : ''}`;
          btn.innerHTML = `<div>${escapeHtml(s.title)}</div><div class="session-meta">Î©îÏãúÏßÄ ${s.message_count}</div>`;
          btn.onclick = async () => {
            const data = await window.pywebview.api.switch_session(s.session_id);
            applySessionState(data);
          };
          root.appendChild(btn);
        });
      }

      function renderMessages() {
        const root = $('messages');
        root.innerHTML = '';
        state.messages.forEach((m) => {
          const bubble = document.createElement('div');
          bubble.className = `bubble ${m.role === 'user' ? 'user' : 'assistant'}`;
          bubble.textContent = m.text || '';
          root.appendChild(bubble);
        });
      }

      function renderSessionPanelVisibility() {
        const panel = $('sessions');
        const main = $('main-layout');
        if (state.sessionsVisible) {
          panel.classList.remove('hidden');
          main.style.gridTemplateColumns = '260px 1fr';
        } else {
          panel.classList.add('hidden');
          main.style.gridTemplateColumns = '1fr';
        }
      }

      function applySessionState(data) {
        state.sessions = data.sessions || [];
        state.currentSessionId = data.current_session_id || null;
        state.messages = data.messages || [];
        renderSessions();
        renderMessages();
      }

      function escapeHtml(str) {
        return (str || '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;');
      }

      async function init() {
        const data = await window.pywebview.api.get_initial_state();
        state.connectionOk = !!data.connection_ok;
        applySessionState(data);
        renderStatus();
        renderSessionPanelVisibility();
      }

      $('btn-new').onclick = async () => {
        const data = await window.pywebview.api.new_session();
        applySessionState(data);
      };

      $('btn-toggle').onclick = () => {
        state.sessionsVisible = !state.sessionsVisible;
        renderSessionPanelVisibility();
      };

      $('btn-delete').onclick = async () => {
        if (!state.currentSessionId) return;
        const data = await window.pywebview.api.delete_session(state.currentSessionId);
        applySessionState(data);
      };

      $('btn-install').onclick = async () => toast(await window.pywebview.api.install_build_engine());
      $('btn-download').onclick = async () => toast(await window.pywebview.api.download_model());

      $('input').addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const text = $('input').value.trim();
          if (!text) return;
          const data = await window.pywebview.api.send_message(text);
          $('input').value = '';
          applySessionState(data);
        }
      });

      window.addEventListener('pywebviewready', init);
    </script>
  </body>
</html>
